#!/usr/bin/env node

const ezs = require('ezs');
ezs.use(require('ezs-basics'));
ezs.use(require('..'));

const output = 'doi,id,title,author,publicationDate,host.eissn,host.issn,host.isbn,host.eisbn,host.genre,host.title,'
              + 'subject';

process.stdin.resume();
process.stdin.setEncoding('utf8');
process.stdin
  .pipe(ezs('stringify'))
  .pipe(ezs('ISTEXCorpus'))
  .pipe(ezs('ISTEXQuery', { params: { output, }, }))
  .pipe(ezs('ISTEXScroll', { params: { size: 1000, duration: '10m', }, }))
  .pipe(ezs('ISTEXHits'))
  .pipe(ezs('flatten'))
  .pipe(ezs('ISTEXPrepare'))
  .pipe(ezs('ISTEXTriplify', {
    properties: {
      'ISTEX/doi/': 'http://purl.org/ontology/bibo/doi',
      'ISTEX/title': 'http://purl.org/dc/terms/title',
      // 'ISTEX/language/': 'http://purl.org/dc/terms/language',
      'ISTEX/author/\\d+/name': 'http://purl.org/dc/terms/creator',
      'ISTEX/author/\\d+/affiliations': 'https://data.istex.fr/ontology/istex#affiliation',
      'ISTEX/publicationDate': 'http://purl.org/dc/terms/issued',
      'ISTEX/subject/\\d/value': 'http://purl.org/dc/terms/subject',
      'ISTEX/publisher': 'http://purl.org/dc/terms/publisher',
      'ISTEX/host/journal/title': 'http://purl.org/ontology/bibo/Journal',
      'ISTEX/host/series/title': 'http://purl.org/ontology/bibo/Series',
      'ISTEX/host/book/title': 'http://purl.org/ontology/bibo/Book',
      'ISTEX/host/manual/title': 'http://purl.org/ontology/bibo/Manual',
      'ISTEX/host/database/title': '',
      'ISTEX/host/eissn/': 'http://purl.org/ontology/bibo/eissn',
      'ISTEX/host/issn/': 'http://purl.org/ontology/bibo/issn',
      'ISTEX/host/isbn/': 'http://purl.org/ontology/bibo/isbn',
      'ISTEX/host/eisbn/': 'http://purl.org/ontology/bibo/isbn',
    },
  }))
  // .pipe(ezs('jsonify'))
  .pipe(process.stdout)
;

